---
import ContactCard from './ContactCard.astro';

interface Contact {
  id: number;
  nombre: string;
  departamento: string;
  email: string;
  telefono: string;
  extension: string;
  imagen?: string | null;
  initials: string;
  avatarColor: string;
}

interface Props {
  contacts: Contact[];
}

const { contacts } = Astro.props;
---

<div class="modal-overlay" id="contactsModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">
        <div class="modal-title-icon">
          <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        </div>
        Contactos
      </h2>
      <button class="modal-close" id="closeContactsModal">
        <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="contacts-search">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <input type="text" id="contactSearch" placeholder="Buscar contacto...">
      </div>
      <div class="contacts-list" id="contactsList">
        {contacts.map(contact => (
          <ContactCard {...contact} />
        ))}
      </div>
      <div class="no-results" id="noResults" style="display: none;">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
        <p>No se encontraron contactos</p>
      </div>
    </div>
  </div>
</div>

<!-- Hidden template for dynamic rendering -->
<template id="contactCardTemplate">
  <div class="contact-card">
    <div class="contact-avatar"></div>
    <div class="contact-info">
      <div class="contact-name"></div>
      <div class="contact-department-row">
        <span class="contact-department"></span>
        <div class="contact-email-container">
          <span class="contact-email"></span>
          <button class="copy-email-btn" title="Copiar correo">
            <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            <span class="copy-tooltip">Â¡Copiado!</span>
          </button>
        </div>
      </div>
      <div class="contact-phone">
        <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>
        <span class="phone-number"></span>
        <span class="contact-extension"></span>
      </div>
    </div>
  </div>
</template>

<style>
/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(10, 23, 68, 0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-normal);
  padding: 20px;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background-color: var(--color-bg-secondary);
  border-radius: var(--border-radius-lg);
  width: 100%;
  max-width: 700px;
  max-height: 85vh;
  overflow: hidden;
  transform: scale(0.9) translateY(20px);
  transition: transform var(--transition-normal);
  display: flex;
  flex-direction: column;
}

.modal-overlay.active .modal {
  transform: scale(1) translateY(0);
}

.modal-header {
  background: linear-gradient(135deg, var(--color-module-bg) 0%, #2563eb 100%);
  padding: 25px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 15px;
}

.modal-title-icon {
  width: 40px;
  height: 40px;
  background-color: rgba(255, 255, 255, 0.15);
  border-radius: var(--border-radius-sm);
  display: flex;
  justify-content: center;
  align-items: center;
}

.modal-title-icon svg {
  width: 24px;
  height: 24px;
  fill: var(--color-gold);
}

.modal-close {
  width: 40px;
  height: 40px;
  background-color: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: var(--transition-fast);
}

.modal-close:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

.modal-close svg {
  width: 20px;
  height: 20px;
  fill: var(--color-text-white);
}

.modal-body {
  padding: 25px 30px;
  overflow-y: auto;
  flex: 1;
}

/* Search */
.contacts-search {
  position: relative;
  margin-bottom: 20px;
}

.contacts-search input {
  width: 100%;
  padding: 15px 20px 15px 50px;
  background-color: var(--color-module-bg);
  border: 2px solid transparent;
  border-radius: var(--border-radius-md);
  color: var(--color-text-white);
  font-family: inherit;
  font-size: 14px;
  transition: var(--transition-fast);
}

.contacts-search input::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

.contacts-search input:focus {
  outline: none;
  border-color: var(--color-gold);
}

.contacts-search svg {
  position: absolute;
  left: 18px;
  top: 50%;
  transform: translateY(-50%);
  width: 20px;
  height: 20px;
  fill: rgba(255, 255, 255, 0.5);
}

/* Contacts List */
.contacts-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 450px;
  overflow-y: auto;
  padding-right: 5px;
}

/* No Results */
.no-results {
  text-align: center;
  padding: 40px 20px;
  color: var(--color-text-light);
}

.no-results svg {
  width: 60px;
  height: 60px;
  fill: rgba(255, 255, 255, 0.3);
  margin-bottom: 15px;
}

.no-results p {
  font-size: 14px;
}

/* Responsive */
@media (max-width: 1024px) {
  .modal {
    max-width: 90%;
  }
}

@media (max-width: 768px) {
  .modal-header {
    padding: 20px;
  }

  .modal-body {
    padding: 20px;
  }
}

@media (max-width: 576px) {
  .modal-title {
    font-size: 1.2rem;
  }
}
</style>

<script>
// Store contacts data for filtering
let allContacts: any[] = [];

function initContactsModal() {
  const modal = document.getElementById('contactsModal');
  const closeBtn = document.getElementById('closeContactsModal');
  const searchInput = document.getElementById('contactSearch') as HTMLInputElement;
  const contactsList = document.getElementById('contactsList');

  // Collect initial contacts from DOM
  if (contactsList) {
    const cards = contactsList.querySelectorAll('.contact-card');
    allContacts = Array.from(cards).map(card => {
      const name = card.querySelector('.contact-name')?.textContent || '';
      const dept = card.querySelector('.contact-department')?.textContent || '';
      const email = card.querySelector('.contact-email')?.textContent || '';
      const ext = card.querySelector('.contact-extension')?.textContent?.replace('Ext. ', '') || '';
      return { element: card, name, dept, email, ext };
    });
  }

  // Close modal
  closeBtn?.addEventListener('click', () => {
    modal?.classList.remove('active');
    document.body.style.overflow = '';
  });

  // Close on overlay click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  // Close on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('active')) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  // Search filtering
  searchInput?.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    const noResults = document.getElementById('noResults');
    let visibleCount = 0;

    allContacts.forEach(({ element, name, dept, email, ext }) => {
      const matches = name.toLowerCase().includes(term) ||
                     dept.toLowerCase().includes(term) ||
                     email.toLowerCase().includes(term) ||
                     ext.includes(term);

      (element as HTMLElement).style.display = matches ? '' : 'none';
      if (matches) visibleCount++;
    });

    if (noResults) {
      noResults.style.display = visibleCount === 0 ? '' : 'none';
    }
  });

  // Copy email buttons
  initCopyButtons();
}

function initCopyButtons() {
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const button = target.closest('.copy-email-btn') as HTMLButtonElement;

    if (button) {
      const email = button.dataset.email || button.previousElementSibling?.textContent || '';
      navigator.clipboard.writeText(email).then(() => {
        button.classList.add('copied');
        setTimeout(() => button.classList.remove('copied'), 2000);
      });
    }
  });
}

document.addEventListener('DOMContentLoaded', initContactsModal);
</script>
