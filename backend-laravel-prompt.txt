# PROMPT PARA GENERACIÓN DE BACKEND EN LARAVEL
# Sistema de Panel de Comunicación Empresarial Multi-tenant

## CONTEXTO DEL PROYECTO

Necesito que generes un backend completo en Laravel para un sistema de Panel de Comunicación Empresarial multi-tenant. El sistema permite que múltiples empresas tengan su propio dashboard personalizado con módulos, calendario, directorio de contactos, cintillo de noticias y banner de imágenes.

Este backend debe conectarse con un frontend hecho en Astro que consume una API GraphQL.

---

## REQUISITOS TÉCNICOS

### Stack Tecnológico
- **Framework**: Laravel 11.x (última versión estable)
- **Base de datos**: PostgreSQL 15+
- **API**: GraphQL usando Laravel Lighthouse
- **Autenticación**: Laravel Sanctum con tokens JWT
- **Caché**: Redis con estrategia de caché multinivel
- **Colas**: Redis con Laravel Horizon para jobs
- **Correo**: Laravel Mail con templates Blade
- **Almacenamiento**: Laravel Storage con driver S3/local

### Estructura del Proyecto
```
app/
├── Console/
│   └── Commands/
│       ├── ClearExpiredSessions.php
│       ├── RefreshNewsCache.php
│       └── CleanupActivityLogs.php
├── Events/
│   ├── UserRegistered.php
│   ├── UserLoggedIn.php
│   ├── PasswordResetRequested.php
│   ├── NewsCacheInvalidated.php
│   └── CompanyConfigurationUpdated.php
├── Listeners/
│   ├── SendWelcomeEmail.php
│   ├── LogUserActivity.php
│   └── InvalidateCompanyCache.php
├── GraphQL/
│   ├── Mutations/
│   ├── Queries/
│   ├── Types/
│   └── Directives/
├── Http/
│   ├── Controllers/
│   │   ├── Api/
│   │   │   └── GraphQLController.php
│   │   └── Admin/
│   │       ├── DashboardController.php
│   │       ├── CompanyController.php
│   │       ├── UserController.php
│   │       ├── ModuleController.php
│   │       ├── NewsController.php
│   │       ├── CalendarController.php
│   │       ├── ContactController.php
│   │       └── BannerController.php
│   ├── Middleware/
│   │   ├── EnsureCompanyAccess.php
│   │   ├── EnsureAdminRole.php
│   │   └── CacheResponse.php
│   └── Requests/
│       ├── LoginRequest.php
│       ├── UserRequest.php
│       ├── ModuleRequest.php
│       ├── NewsRequest.php
│       └── [otros requests de validación]
├── Jobs/
│   ├── ProcessImageUpload.php
│   ├── SendBulkEmails.php
│   └── CleanupExpiredTokens.php
├── Mail/
│   ├── WelcomeAdminEmail.php
│   ├── WelcomeUserEmail.php
│   ├── PasswordResetEmail.php
│   └── NewUserNotification.php
├── Models/
│   ├── Company.php
│   ├── CompanyConfiguration.php
│   ├── User.php
│   ├── UserSession.php
│   ├── Module.php
│   ├── CalendarEvent.php
│   ├── News.php
│   ├── Contact.php
│   ├── BannerImage.php
│   ├── ActivityLog.php
│   ├── PasswordResetToken.php
│   └── CacheSetting.php
├── Observers/
│   ├── UserObserver.php
│   ├── NewsObserver.php
│   └── CompanyConfigurationObserver.php
├── Policies/
│   ├── CompanyPolicy.php
│   ├── UserPolicy.php
│   ├── ModulePolicy.php
│   └── NewsPolicy.php
├── Repositories/
│   ├── Interfaces/
│   └── Eloquent/
├── Services/
│   ├── AuthService.php
│   ├── CacheService.php
│   ├── ImageService.php
│   ├── EmailService.php
│   └── ActivityLogService.php
└── Traits/
    ├── HasCompanyScope.php
    ├── HasSoftDeletes.php
    └── HasActivityLog.php
```

---

## MODELO DE DATOS

### Estructura de Base de Datos
Usar el esquema PostgreSQL proporcionado en el archivo `database/schema.sql`. Las tablas principales son:

1. **companies** - Empresas/organizaciones
2. **company_configurations** - Configuración visual (logo, colores, branding)
3. **users** - Usuarios con roles (super_admin, admin, user)
4. **user_sessions** - Sesiones activas
5. **modules** - Módulos/items del dashboard
6. **calendar_events** - Eventos del calendario
7. **news** - Noticias del cintillo
8. **contacts** - Directorio de contactos
9. **banner_images** - Imágenes del banner/slider
10. **activity_logs** - Logs de actividad
11. **password_reset_tokens** - Tokens de recuperación
12. **cache_settings** - Configuración de TTL por empresa

---

## SISTEMA DE ROLES Y PERMISOS

### Roles
1. **super_admin**: 1 por empresa, puede crear/gestionar otros admins, acceso total
2. **admin**: Hasta 5 por empresa (incluyendo super_admin), gestiona contenido
3. **user**: Usuarios normales, solo lectura del dashboard

### Reglas de Negocio
- Solo el super_admin puede crear nuevos administradores
- Máximo 5 administradores (super_admin + 4 admin) por empresa
- El super_admin no puede ser eliminado ni cambiar de rol
- Cada usuario solo puede ver información de SU empresa (multi-tenant)

---

## SISTEMA DE CACHÉ AVANZADO

### Estrategia de Caché
```php
// Configuración de TTL por tipo de contenido
[
    'modules' => 600,       // 10 minutos
    'contacts' => 600,      // 10 minutos
    'events' => 600,        // 10 minutos
    'news' => 60,           // 1 minuto (actualización frecuente)
    'banner' => 600,        // 10 minutos
    'config' => 3600,       // 1 hora
    'user_session' => 3600, // 1 hora
]
```

### Implementación
- Usar Redis como driver principal
- Implementar cache tags por empresa: `company:{id}:modules`
- Invalidación selectiva cuando se actualiza contenido
- Cache warming al iniciar la aplicación
- Considerar que las noticias cambian 1-2 veces al día, usar TTL corto

### Servicio de Caché
```php
class CacheService
{
    public function getOrSet(string $key, callable $callback, int $ttl, array $tags = []);
    public function invalidateByTag(string $tag);
    public function invalidateCompanyCache(string $companyId, ?string $type = null);
    public function warmCache(string $companyId);
    public function getStats(): array;
}
```

---

## AUTENTICACIÓN Y SEGURIDAD

### Login Flow
1. Usuario envía email + password + companyId
2. Validar credenciales contra hash bcrypt
3. Verificar que usuario pertenece a la empresa
4. Crear sesión en `user_sessions` con token único
5. Retornar token JWT con claims de empresa y rol
6. Registrar actividad de login

### Tokens y Sesiones
- Tokens JWT con expiración de 1 hora
- Refresh tokens con expiración de 7 días
- Invalidar todas las sesiones al cambiar contraseña
- Limitar sesiones activas por usuario (máx 5)

### Middleware de Seguridad
```php
// EnsureCompanyAccess - Verificar que el recurso pertenece a la empresa del usuario
// EnsureAdminRole - Verificar rol de admin para operaciones CRUD
// RateLimiter - Limitar intentos de login (5 por minuto)
```

---

## API GRAPHQL

### Schema Principal
```graphql
type Query {
    # Dashboard
    modules(companyId: ID!): [Module!]!
    module(id: ID!): Module

    contacts(companyId: ID!, search: String): [Contact!]!
    contact(id: ID!): Contact

    calendarEvents(companyId: ID!, month: Int, year: Int): [CalendarEvent!]!
    eventByDay(companyId: ID!, day: Int!): CalendarEvent

    newsItems(companyId: ID!): [NewsItem!]!

    bannerImages(companyId: ID!): [BannerImage!]!

    companyConfiguration(companyId: ID!): CompanyConfiguration

    # Admin
    companies(search: String): [Company!]! @guard
    company(id: ID!): Company @guard

    users(companyId: ID!, role: String): [User!]! @guard
    user(id: ID!): User @guard

    activityLogs(companyId: ID!, limit: Int): [ActivityLog!]! @guard

    cacheStats: CacheStats! @guard
}

type Mutation {
    # Auth
    login(email: String!, password: String!, companyId: ID!): AuthPayload!
    logout: Boolean!
    refreshToken(refreshToken: String!): AuthPayload!
    requestPasswordReset(email: String!): MessageResponse!
    resetPassword(token: String!, password: String!, passwordConfirmation: String!): MessageResponse!

    # Users (Admin)
    createUser(input: CreateUserInput!): User! @guard
    updateUser(id: ID!, input: UpdateUserInput!): User! @guard
    deleteUser(id: ID!): Boolean! @guard

    # Modules (Admin)
    createModule(input: CreateModuleInput!): Module! @guard
    updateModule(id: ID!, input: UpdateModuleInput!): Module! @guard
    deleteModule(id: ID!): Boolean! @guard
    reorderModules(ids: [ID!]!): Boolean! @guard

    # News (Admin)
    createNews(input: CreateNewsInput!): NewsItem! @guard
    updateNews(id: ID!, input: UpdateNewsInput!): NewsItem! @guard
    deleteNews(id: ID!): Boolean! @guard

    # Calendar Events (Admin)
    createCalendarEvent(input: CreateEventInput!): CalendarEvent! @guard
    updateCalendarEvent(id: ID!, input: UpdateEventInput!): CalendarEvent! @guard
    deleteCalendarEvent(id: ID!): Boolean! @guard

    # Contacts (Admin)
    createContact(input: CreateContactInput!): Contact! @guard
    updateContact(id: ID!, input: UpdateContactInput!): Contact! @guard
    deleteContact(id: ID!): Boolean! @guard

    # Banner (Admin)
    uploadBannerImage(file: Upload!, companyId: ID!): BannerImage! @guard
    deleteBannerImage(id: ID!): Boolean! @guard
    reorderBannerImages(ids: [ID!]!): Boolean! @guard

    # Company Configuration (Admin)
    updateCompanyConfiguration(companyId: ID!, input: UpdateConfigInput!): CompanyConfiguration! @guard
    uploadCompanyLogo(file: Upload!, companyId: ID!): CompanyConfiguration! @guard

    # Cache (Admin)
    clearCache(companyId: ID!): Boolean! @guard
    refreshCache(companyId: ID!, type: String!): Boolean! @guard
}

# Inputs y Types según el schema de BD
```

---

## SISTEMA DE EMAILS

### Templates Requeridos

1. **WelcomeAdminEmail** - Cuando se crea un nuevo admin
   - Datos de acceso
   - Link al panel de administración
   - Instrucciones iniciales

2. **WelcomeUserEmail** - Cuando se crea un usuario normal
   - Datos de acceso
   - Link al dashboard
   - Información de la empresa

3. **PasswordResetEmail** - Solicitud de recuperación de contraseña
   - Link con token (válido 1 hora)
   - Instrucciones de seguridad

4. **PasswordChangedEmail** - Notificación de cambio de contraseña
   - Aviso de seguridad
   - Instrucciones si no fue el usuario

### Configuración
```php
// Usar queue para envío asíncrono
// Templates en español
// Soporte para personalización con logo de empresa
```

---

## TRATAMIENTO DE IMÁGENES

### ImageService
```php
class ImageService
{
    public function upload(UploadedFile $file, string $path): array;
    public function resize(string $path, int $width, int $height): string;
    public function optimize(string $path): void;
    public function getMetadata(string $path): array;
    public function delete(string $path): bool;
}
```

### Metadata a Guardar
- URL del archivo
- Nombre original
- Tipo MIME
- Tamaño en bytes
- Dimensiones (ancho x alto)
- Hash MD5 para detectar duplicados
- Fecha de subida

### Validaciones
- Formatos permitidos: jpg, jpeg, png, gif, webp, svg (solo logos)
- Tamaño máximo: 5MB para banner, 1MB para logo
- Dimensiones mínimas para banner: 800x400px
- Procesamiento con Intervention Image

---

## VALIDACIONES Y MENSAJES

### FormRequest con Mensajes en Español
```php
class UserRequest extends FormRequest
{
    public function rules(): array
    {
        return [
            'email' => ['required', 'email', 'unique:users,email'],
            'password' => ['required', 'min:8', 'confirmed'],
            'name' => ['required', 'string', 'min:2', 'max:255'],
            'role' => ['required', 'in:super_admin,admin,user'],
        ];
    }

    public function messages(): array
    {
        return [
            'email.required' => 'El correo electrónico es obligatorio.',
            'email.email' => 'El formato del correo electrónico no es válido.',
            'email.unique' => 'Este correo electrónico ya está registrado.',
            'password.required' => 'La contraseña es obligatoria.',
            'password.min' => 'La contraseña debe tener al menos :min caracteres.',
            'password.confirmed' => 'La confirmación de contraseña no coincide.',
            'name.required' => 'El nombre es obligatorio.',
            'name.min' => 'El nombre debe tener al menos :min caracteres.',
            'role.required' => 'El rol es obligatorio.',
            'role.in' => 'El rol seleccionado no es válido.',
        ];
    }
}
```

### Respuestas de API Estandarizadas
```php
class ApiResponse
{
    public static function success($data, string $message = 'Operación exitosa'): JsonResponse;
    public static function error(string $message, int $code = 400, array $errors = []): JsonResponse;
    public static function validationError(array $errors): JsonResponse;
    public static function unauthorized(string $message = 'No autorizado'): JsonResponse;
    public static function notFound(string $message = 'Recurso no encontrado'): JsonResponse;
}
```

---

## SISTEMA DE EVENTOS

### Eventos Principales
```php
// UserRegistered - Disparar email de bienvenida, log de actividad
// UserLoggedIn - Log de actividad, actualizar last_login_at
// PasswordResetRequested - Enviar email con token
// PasswordChanged - Invalidar sesiones, notificar usuario
// NewsCacheInvalidated - Refrescar caché de noticias
// CompanyConfigurationUpdated - Invalidar caché de configuración
// ModuleUpdated - Invalidar caché de módulos
// ContentCreated - Log de actividad
// ContentDeleted - Log de actividad (soft delete)
```

### Listeners
```php
// Usar queues para operaciones pesadas
// Agrupar listeners por dominio
// Implementar retry para fallos
```

---

## BORRADO LÓGICO (SOFT DELETE)

### Implementación
- Usar trait `SoftDeletes` en todos los modelos
- Campo `deleted_at` timestamp nullable
- Scopes automáticos para excluir eliminados
- Método `forceDelete()` solo para super_admin

### Restauración
```php
// Permitir restaurar registros eliminados
// Log de actividad en restauración
// Validar dependencias antes de restaurar
```

---

## LOGS DE ACTIVIDAD

### Información a Registrar
- ID de empresa
- ID de usuario
- Acción (login, create, update, delete, etc.)
- Tipo de entidad
- ID de entidad
- Valores anteriores (JSON)
- Valores nuevos (JSON)
- IP del cliente
- User Agent
- Timestamp

### ActivityLogService
```php
class ActivityLogService
{
    public function log(string $action, string $entityType, ?string $entityId, array $context = []): void;
    public function logModelChange(Model $model, string $action): void;
    public function getByCompany(string $companyId, int $limit = 50): Collection;
    public function cleanup(int $daysOld = 90): int;
}
```

---

## PANTALLAS DE ADMINISTRACIÓN

Generar vistas Blade para el panel de administración con las siguientes secciones:

### Dashboard Admin
- Estadísticas generales (usuarios, módulos, noticias)
- Actividad reciente
- Estado del caché
- Alertas del sistema

### Gestión de Usuarios
- Listado con búsqueda y filtros
- Crear/editar usuario
- Asignar roles
- Ver actividad del usuario
- Restablecer contraseña

### Gestión de Módulos
- Listado ordenable (drag & drop)
- Crear/editar módulo
- Previsualización de íconos
- Activar/desactivar

### Gestión de Noticias
- Listado con fechas de programación
- Crear/editar noticia
- Marcar como prioritaria
- Historial de cambios

### Gestión de Calendario
- Vista de calendario mensual
- Crear/editar eventos
- Eventos recurrentes
- Exportar/importar

### Gestión de Contactos
- Listado con búsqueda
- Crear/editar contacto
- Importar desde CSV
- Exportar directorio

### Gestión de Banner
- Galería de imágenes
- Subir/eliminar imágenes
- Reordenar (drag & drop)
- Previsualización

### Configuración de Empresa
- Logo y favicon
- Paleta de colores
- Textos personalizados
- Configuración de caché

---

## CONFIGURACIONES ADICIONALES

### Seguridad
- CORS configurado para dominios permitidos
- Rate limiting por IP y usuario
- Sanitización de inputs
- Protección CSRF
- Headers de seguridad (X-Frame-Options, CSP, etc.)
- Logging de intentos fallidos de autenticación

### Performance
- Query optimization con Eager Loading
- Paginación en listados grandes
- Compresión de respuestas
- HTTP/2 Server Push para assets críticos
- Database connection pooling

### Monitoreo
- Laravel Telescope para debugging (solo en desarrollo)
- Sentry para tracking de errores (producción)
- Logs estructurados en formato JSON
- Health checks endpoint

### Testing
- Tests unitarios para servicios
- Tests de integración para API GraphQL
- Tests de feature para flujos completos
- Factories para datos de prueba

---

## ARCHIVOS DE CONFIGURACIÓN

### .env.example
```
APP_NAME="Panel Empresarial"
APP_ENV=local
APP_KEY=
APP_DEBUG=true
APP_URL=http://localhost

DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=panel_empresarial
DB_USERNAME=postgres
DB_PASSWORD=

CACHE_DRIVER=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=smtp
MAIL_HOST=mailpit
MAIL_PORT=1025
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null
MAIL_FROM_ADDRESS="noreply@example.com"
MAIL_FROM_NAME="${APP_NAME}"

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false

FILESYSTEM_DISK=local

JWT_SECRET=
JWT_TTL=60
JWT_REFRESH_TTL=20160
```

---

## COMANDOS ARTISAN PERSONALIZADOS

```bash
# Limpiar sesiones expiradas
php artisan sessions:cleanup

# Refrescar caché de noticias para todas las empresas
php artisan cache:refresh-news

# Limpiar logs de actividad antiguos
php artisan logs:cleanup --days=90

# Calentar caché para una empresa
php artisan cache:warm --company=uuid

# Generar reporte de uso
php artisan report:usage --month=1 --year=2025
```

---

## CONSIDERACIONES FINALES

1. **Documentación**: Generar documentación de API con Scribe o GraphQL Playground
2. **Seeders**: Incluir seeders con datos de prueba del archivo `database/seeds.sql`
3. **Migrations**: Generar migrations basadas en `database/schema.sql`
4. **Docker**: Incluir docker-compose.yml para desarrollo
5. **CI/CD**: Configuración básica para GitHub Actions
6. **Changelog**: Mantener registro de cambios

---

## NOTAS IMPORTANTES

- Todos los mensajes de error y respuestas deben estar en español
- Seguir convenciones de nombrado de Laravel (snake_case para BD, camelCase para PHP)
- Implementar principios SOLID
- Usar Repository Pattern para acceso a datos
- Documentar código con PHPDoc
- Seguir PSR-12 para estilo de código

---

## INICIO DEL PROYECTO

Ejecutar los siguientes pasos:
1. `composer create-project laravel/laravel panel-empresarial`
2. Instalar dependencias: Lighthouse, Sanctum, Intervention Image, Horizon
3. Configurar PostgreSQL y Redis
4. Ejecutar migrations y seeders
5. Configurar colas con Horizon
6. Generar documentación de API

¡Importante! Este backend debe ser compatible con el frontend Astro existente que consume la API GraphQL en el endpoint `/api/graphql`.
